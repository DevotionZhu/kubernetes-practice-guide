<!DOCTYPE html>
<html lang="zh" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.65.3" />
    <meta name="description" content="Kubernetes 实践指南">
<meta name="author" content="roc">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Thanos 部署与实践</title>

    <script>
      window.algoliaAppID='B6Q6PSGUV5';
      window.algoliaKey='5b4678e9995fe4211c4fa43ad2ffdab5';
      window.algoliaIndex='kubernetes-practice-guide-zh';
    </script>
    
    <script src='https://kubetencent-1251707795.cos.accelerate.myqcloud.com/js/bundle.min.8d534562810f42a5942ec72a0b7ae599c8bf0c96a4c8d6fafffa9bf21fce9d77.js'></script>
    
    
    <link rel="stylesheet"
      href='https://kubetencent-1251707795.cos.accelerate.myqcloud.com/css/bundle.min.b0e6163350b1169d986890f4bd317db6286105863b7a53274abdb5c8d935eaa1.css'>
    

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://k8s.imroc.io/" style="display:block">
  <div style="width:100%; height:100%;" >
    <img src="https://res.cloudinary.com/imroc/image/upload/c_scale,w_64/v1583293443/kubernetes-practice-guide/img/kubernetes.png" />
    <div style="height:100%; margin-bottom:3px; font-weight: bold;">Kubernetes 实践指南</div>
  </div>
</a>
    </div>
    
        
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="搜索..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>

<script type="text/javascript">
    
        var baseurl = "https:\/\/k8s.imroc.io\/";
    
</script>


    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
  
 

          
          




 
  
    
    <li data-nav-id="/deploy/" title="部署指南" class="dd-item 
        
        
        
        ">
      <a href="/deploy/">
          部署指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/deploy/selection/" title="方案选型" class="dd-item ">
        <a href="/deploy/selection/">
        方案选型
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deploy/kubespray/" title="使用 kubespray 部署" class="dd-item ">
        <a href="/deploy/kubespray/">
        使用 kubespray 部署
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/deploy/manual/" title="手工部署" class="dd-item 
        
        
        
        ">
      <a href="/deploy/manual/">
          手工部署
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/deploy/manual/prepare/" title="部署前的准备工作" class="dd-item ">
        <a href="/deploy/manual/prepare/">
        部署前的准备工作
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deploy/manual/bootstrapping-etcd/" title="部署 ETCD" class="dd-item ">
        <a href="/deploy/manual/bootstrapping-etcd/">
        部署 ETCD
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deploy/manual/bootstrapping-master/" title="部署 Master" class="dd-item ">
        <a href="/deploy/manual/bootstrapping-master/">
        部署 Master
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deploy/manual/bootstrapping-worker-nodes/" title="部署 Worker 节点" class="dd-item ">
        <a href="/deploy/manual/bootstrapping-worker-nodes/">
        部署 Worker 节点
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deploy/manual/deploy-critical-addons/" title="部署关键组件" class="dd-item ">
        <a href="/deploy/manual/deploy-critical-addons/">
        部署关键组件
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/deploy/addons/" title="附加组件" class="dd-item 
        
        
        
        ">
      <a href="/deploy/addons/">
          附加组件
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/deploy/addons/kube-proxy/" title="以 Daemonset 方式部署 kube-proxy" class="dd-item ">
        <a href="/deploy/addons/kube-proxy/">
        以 Daemonset 方式部署 kube-proxy
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deploy/addons/coredns/" title="部署 CoreDNS" class="dd-item ">
        <a href="/deploy/addons/coredns/">
        部署 CoreDNS
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/deploy/appendix/" title="附录" class="dd-item 
        
        
        
        ">
      <a href="/deploy/appendix/">
          附录
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/deploy/appendix/install-kubectl/" title="安装 kubectl" class="dd-item ">
        <a href="/deploy/appendix/install-kubectl/">
        安装 kubectl
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/ingress/" title="Ingress 指南" class="dd-item 
        
        
        
        ">
      <a href="/ingress/">
          Ingress 指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/ingress/understand/" title="彻底理解 Ingress" class="dd-item ">
        <a href="/ingress/understand/">
        彻底理解 Ingress
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/ingress/choose/" title="Ingress 方案选型" class="dd-item ">
        <a href="/ingress/choose/">
        Ingress 方案选型
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/ingress/nginx-ingress/" title="Nginx Ingress" class="dd-item 
        
        
        
        ">
      <a href="/ingress/nginx-ingress/">
          Nginx Ingress
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/ingress/nginx-ingress/install-nginx-ingress/" title="安装 nginx ingress controller" class="dd-item ">
        <a href="/ingress/nginx-ingress/install-nginx-ingress/">
        安装 nginx ingress controller
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/ingress/traefik-ingress/" title="Traefik Ingress" class="dd-item 
        
        
        
        ">
      <a href="/ingress/traefik-ingress/">
          Traefik Ingress
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/ingress/traefik-ingress/install-traefik-ingress/" title="安装 traefik ingress controller" class="dd-item ">
        <a href="/ingress/traefik-ingress/install-traefik-ingress/">
        安装 traefik ingress controller
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/ingress/traefik-ingress/use-traefik-to-support-login/" title="使用 Traefik V2 让你的后台管理页面支持登录" class="dd-item ">
        <a href="/ingress/traefik-ingress/use-traefik-to-support-login/">
        使用 Traefik V2 让你的后台管理页面支持登录
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/metrics/" title="Metrics 指南" class="dd-item 
        
        
        
        ">
      <a href="/metrics/">
          Metrics 指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/configuration/" title="配置管理" class="dd-item 
        
        
        
        ">
      <a href="/configuration/">
          配置管理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/configuration/helm/" title="使用 Helm 管理集群资源" class="dd-item 
        
        
        
        ">
      <a href="/configuration/helm/">
          使用 Helm 管理集群资源
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/configuration/helm/install-helm/" title="安装 Helm" class="dd-item ">
        <a href="/configuration/helm/install-helm/">
        安装 Helm
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/configuration/helm/upgrade-helm-v2-to-v3/" title="Helm V2 迁移到 V3" class="dd-item ">
        <a href="/configuration/helm/upgrade-helm-v2-to-v3/">
        Helm V2 迁移到 V3
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/configuration/helm/helm-faq/" title="Helm 常见问题" class="dd-item ">
        <a href="/configuration/helm/helm-faq/">
        Helm 常见问题
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/troubleshooting/" title="排错指南" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/">
          排错指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/troubleshooting/trick/" title="排错技巧" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/trick/">
          排错技巧
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/trick/analysis-exitcode/" title="分析 ExitCode 定位 Pod 异常退出原因" class="dd-item ">
        <a href="/troubleshooting/trick/analysis-exitcode/">
        分析 ExitCode 定位 Pod 异常退出原因
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/trick/use-systemtap-to-locate-problems/" title="使用 Systemtap 定位疑难杂症" class="dd-item ">
        <a href="/troubleshooting/trick/use-systemtap-to-locate-problems/">
        使用 Systemtap 定位疑难杂症
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/trick/capture-packets-in-container/" title="容器内抓包定位网络问题" class="dd-item ">
        <a href="/troubleshooting/trick/capture-packets-in-container/">
        容器内抓包定位网络问题
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/troubleshooting/handle/" title="处理实践" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/handle/">
          处理实践
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/handle/arp_cache-overflow/" title="arp_cache 溢出" class="dd-item ">
        <a href="/troubleshooting/handle/arp_cache-overflow/">
        arp_cache 溢出
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/handle/runnig-out-of-inotify-watches/" title="inotify watch 耗尽" class="dd-item ">
        <a href="/troubleshooting/handle/runnig-out-of-inotify-watches/">
        inotify watch 耗尽
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/handle/pid-full/" title="PID 耗尽" class="dd-item ">
        <a href="/troubleshooting/handle/pid-full/">
        PID 耗尽
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/handle/memory-fragmentation/" title="内存碎片化" class="dd-item ">
        <a href="/troubleshooting/handle/memory-fragmentation/">
        内存碎片化
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/handle/disk-full/" title="磁盘爆满" class="dd-item ">
        <a href="/troubleshooting/handle/disk-full/">
        磁盘爆满
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/handle/high-load/" title="高负载" class="dd-item ">
        <a href="/troubleshooting/handle/high-load/">
        高负载
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/troubleshooting/node/" title="节点排错" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/node/">
          节点排错
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/node/arp_cache-neighbor-table-overflow/" title="arp_cache: neighbor table overflow! (arp缓存溢出)" class="dd-item ">
        <a href="/troubleshooting/node/arp_cache-neighbor-table-overflow/">
        arp_cache: neighbor table overflow! (arp缓存溢出)
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/node/cannot-allocate-memory/" title="Cannot allocate memory" class="dd-item ">
        <a href="/troubleshooting/node/cannot-allocate-memory/">
        Cannot allocate memory
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/node/no-space-left-on-device/" title="no space left on device" class="dd-item ">
        <a href="/troubleshooting/node/no-space-left-on-device/">
        no space left on device
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/node/not-ready/" title="Node NotReady" class="dd-item ">
        <a href="/troubleshooting/node/not-ready/">
        Node NotReady
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/node/kernel-solft-lockup/" title="soft lockup (内核软死锁)" class="dd-item ">
        <a href="/troubleshooting/node/kernel-solft-lockup/">
        soft lockup (内核软死锁)
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/troubleshooting/pod/" title="Pod 排错" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/pod/">
          Pod 排错
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/slow-terminating/" title="Pod Terminating 慢" class="dd-item ">
        <a href="/troubleshooting/pod/slow-terminating/">
        Pod Terminating 慢
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-containercreating-or-waiting/" title="Pod 一直处于 ContainerCreating 或 Waiting 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-containercreating-or-waiting/">
        Pod 一直处于 ContainerCreating 或 Waiting 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-error/" title="Pod 一直处于 Error 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-error/">
        Pod 一直处于 Error 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-imageinspecterror/" title="Pod 一直处于 ImageInspectError 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-imageinspecterror/">
        Pod 一直处于 ImageInspectError 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-imagepullbackoff/" title="Pod 一直处于 ImagePullBackOff 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-imagepullbackoff/">
        Pod 一直处于 ImagePullBackOff 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-pending/" title="Pod 一直处于 Pending 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-pending/">
        Pod 一直处于 Pending 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-terminating/" title="Pod 一直处于 Terminating 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-terminating/">
        Pod 一直处于 Terminating 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-unkown/" title="Pod 一直处于 Unknown 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-unkown/">
        Pod 一直处于 Unknown 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/healthcheck-failed/" title="Pod 健康检查失败" class="dd-item ">
        <a href="/troubleshooting/pod/healthcheck-failed/">
        Pod 健康检查失败
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/keep-crashloopbackoff/" title="Pod 处于 CrashLoopBackOff 状态" class="dd-item ">
        <a href="/troubleshooting/pod/keep-crashloopbackoff/">
        Pod 处于 CrashLoopBackOff 状态
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/pod/container-proccess-exit-by-itself/" title="容器进程主动退出" class="dd-item ">
        <a href="/troubleshooting/pod/container-proccess-exit-by-itself/">
        容器进程主动退出
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/troubleshooting/network/" title="网络排错" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/network/">
          网络排错
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/network/manual/" title="网络排错手册" class="dd-item ">
        <a href="/troubleshooting/network/manual/">
        网络排错手册
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/network/dns/" title="DNS 解析异常" class="dd-item ">
        <a href="/troubleshooting/network/dns/">
        DNS 解析异常
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/network/lb-healthcheck-failed/" title="LB 健康检查失败" class="dd-item ">
        <a href="/troubleshooting/network/lb-healthcheck-failed/">
        LB 健康检查失败
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/network/service-unrecheable/" title="Service 不通" class="dd-item ">
        <a href="/troubleshooting/network/service-unrecheable/">
        Service 不通
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/network/service-cannot-resolve/" title="Service 无法解析" class="dd-item ">
        <a href="/troubleshooting/network/service-cannot-resolve/">
        Service 无法解析
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/network/low-throughput/" title="网络性能差" class="dd-item ">
        <a href="/troubleshooting/network/low-throughput/">
        网络性能差
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/troubleshooting/others/" title="其它排错" class="dd-item 
        
        
        
        ">
      <a href="/troubleshooting/others/">
          其它排错
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/others/slow-apiserver/" title="APIServer 响应慢" class="dd-item ">
        <a href="/troubleshooting/others/slow-apiserver/">
        APIServer 响应慢
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/others/daemonset-not-scheduled/" title="Daemonset 没有被调度" class="dd-item ">
        <a href="/troubleshooting/others/daemonset-not-scheduled/">
        Daemonset 没有被调度
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/others/job-cannot-delete/" title="Job 无法被删除" class="dd-item ">
        <a href="/troubleshooting/others/job-cannot-delete/">
        Job 无法被删除
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/others/kubectl-exec-or-logs-failed/" title="kubectl 执行 exec 或 logs 失败" class="dd-item ">
        <a href="/troubleshooting/others/kubectl-exec-or-logs-failed/">
        kubectl 执行 exec 或 logs 失败
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/others/namespace-stuck-on-terminating/" title="Namespace 卡在 Terminating" class="dd-item ">
        <a href="/troubleshooting/others/namespace-stuck-on-terminating/">
        Namespace 卡在 Terminating
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/troubleshooting/others/node-all-gone/" title="Node 全部消失" class="dd-item ">
        <a href="/troubleshooting/others/node-all-gone/">
        Node 全部消失
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/avoid/" title="避坑指南" class="dd-item 
        
        
        
        ">
      <a href="/avoid/">
          避坑指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/avoid/dotnet-configuration-auto-reload/" title=".Net Core 配置文件在Kubernetes中无法热加载" class="dd-item ">
        <a href="/avoid/dotnet-configuration-auto-reload/">
        .Net Core 配置文件在Kubernetes中无法热加载
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cgroup-leaking/" title="cgroup 泄露" class="dd-item ">
        <a href="/avoid/cgroup-leaking/">
        cgroup 泄露
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/conntrack-conflict/" title="conntrack 冲突导致丢包" class="dd-item ">
        <a href="/avoid/conntrack-conflict/">
        conntrack 冲突导致丢包
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/tcp_tw_recycle-causes-packet-loss/" title="tcp tw recycle 引发丢包" class="dd-item ">
        <a href="/avoid/tcp_tw_recycle-causes-packet-loss/">
        tcp tw recycle 引发丢包
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/nodelocal-dns/" title="使用 NodeLocal DNS (缓存)" class="dd-item ">
        <a href="/avoid/nodelocal-dns/">
        使用 NodeLocal DNS (缓存)
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/handle-cgroup-oom-in-userspace-with-oom-guard/" title="使用 oom-guard 在用户态处理 cgroup OOM" class="dd-item ">
        <a href="/avoid/handle-cgroup-oom-in-userspace-with-oom-guard/">
        使用 oom-guard 在用户态处理 cgroup OOM
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/scale-keepalive-service/" title="解决长连接服务扩容失效" class="dd-item ">
        <a href="/avoid/scale-keepalive-service/">
        解决长连接服务扩容失效
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/avoid/cases/" title="踩坑分享" class="dd-item 
        
        
        
        ">
      <a href="/avoid/cases/">
          踩坑分享
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/arp-cache-overflow-causes-healthcheck-failed/" title="ARP 缓存爆满导致健康检查失败" class="dd-item ">
        <a href="/avoid/cases/arp-cache-overflow-causes-healthcheck-failed/">
        ARP 缓存爆满导致健康检查失败
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/dns-lookup-5s-delay/" title="DNS 5 秒延时" class="dd-item ">
        <a href="/avoid/cases/dns-lookup-5s-delay/">
        DNS 5 秒延时
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/dns-resolution-abnormal/" title="DNS 解析异常" class="dd-item ">
        <a href="/avoid/cases/dns-resolution-abnormal/">
        DNS 解析异常
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/schemaerror-when-using-kubectl-apply-or-edit/" title="kubectl edit 或者 apply 报 SchemaError" class="dd-item ">
        <a href="/avoid/cases/schemaerror-when-using-kubectl-apply-or-edit/">
        kubectl edit 或者 apply 报 SchemaError
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/low-cps-from-lb-to-nodeport/" title="LB 压测 NodePort CPS 低" class="dd-item ">
        <a href="/avoid/cases/low-cps-from-lb-to-nodeport/">
        LB 压测 NodePort CPS 低
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/livenesprobe-failed-occasionally/" title="Pod 偶尔存活检查失败" class="dd-item ">
        <a href="/avoid/cases/livenesprobe-failed-occasionally/">
        Pod 偶尔存活检查失败
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/high-legacy-from-pod-to-another-apiserver/" title="Pod 访问另一个集群的 apiserver 有延时" class="dd-item ">
        <a href="/avoid/cases/high-legacy-from-pod-to-another-apiserver/">
        Pod 访问另一个集群的 apiserver 有延时
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/kubernetes-overflow-and-drop/" title="神秘的溢出与丢包" class="dd-item ">
        <a href="/avoid/cases/kubernetes-overflow-and-drop/">
        神秘的溢出与丢包
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/lb-with-local-externaltrafficpolicy-timeout-occasionally/" title="访问 externalTrafficPolicy 为 Local 的 Service 对应 LB 有时超时" class="dd-item ">
        <a href="/avoid/cases/lb-with-local-externaltrafficpolicy-timeout-occasionally/">
        访问 externalTrafficPolicy 为 Local 的 Service 对应 LB 有时超时
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/no-route-to-host/" title="诡异的 No route to host" class="dd-item ">
        <a href="/avoid/cases/no-route-to-host/">
        诡异的 No route to host
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/cross-vpc-connect-nodeport-timeout/" title="跨 VPC 访问 NodePort 经常超时" class="dd-item ">
        <a href="/avoid/cases/cross-vpc-connect-nodeport-timeout/">
        跨 VPC 访问 NodePort 经常超时
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/avoid/cases/eviction-leads-to-service-disruption/" title="驱逐导致服务中断" class="dd-item ">
        <a href="/avoid/cases/eviction-leads-to-service-disruption/">
        驱逐导致服务中断
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/security/" title="安全指南" class="dd-item 
        
        
        
        ">
      <a href="/security/">
          安全指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/security/user/" title="用户管理" class="dd-item 
        
        
        
        ">
      <a href="/security/user/">
          用户管理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/security/user/create-user-using-csr-api/" title="利用 CSR API 创建用户" class="dd-item ">
        <a href="/security/user/create-user-using-csr-api/">
        利用 CSR API 创建用户
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/security/permission/" title="集群权限控制" class="dd-item 
        
        
        
        ">
      <a href="/security/permission/">
          集群权限控制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/security/permission/app/" title="控制应用权限" class="dd-item ">
        <a href="/security/permission/app/">
        控制应用权限
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/security/permission/user/" title="控制用户权限" class="dd-item ">
        <a href="/security/permission/user/">
        控制用户权限
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/security/cert/" title="集群证书管理" class="dd-item 
        
        
        
        ">
      <a href="/security/cert/">
          集群证书管理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/security/cert/install-cert-manger/" title="安装 cert-manager" class="dd-item ">
        <a href="/security/cert/install-cert-manger/">
        安装 cert-manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/security/cert/autogenerate-certificate-with-cert-manager/" title="使用 cert-manager 自动生成证书" class="dd-item ">
        <a href="/security/cert/autogenerate-certificate-with-cert-manager/">
        使用 cert-manager 自动生成证书
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/best-practice/" title="最佳实践" class="dd-item 
        
        
        
        ">
      <a href="/best-practice/">
          最佳实践
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/best-practice/deploy/" title="服务部署最佳实践" class="dd-item 
        
        
        
        ">
      <a href="/best-practice/deploy/">
          服务部署最佳实践
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/best-practice/deploy/resource-utilization/" title="如何合理利用资源" class="dd-item ">
        <a href="/best-practice/deploy/resource-utilization/">
        如何合理利用资源
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/best-practice/deploy/highly-available/" title="如何提高服务可用性" class="dd-item ">
        <a href="/best-practice/deploy/highly-available/">
        如何提高服务可用性
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/best-practice/etcd/" title="ETCD 优化" class="dd-item ">
        <a href="/best-practice/etcd/">
        ETCD 优化
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/best-practice/master/" title="Master 优化" class="dd-item ">
        <a href="/best-practice/master/">
        Master 优化
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/best-practice/kernel/" title="内核参数优化" class="dd-item ">
        <a href="/best-practice/kernel/">
        内核参数优化
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/trick/" title="奇技淫巧" class="dd-item 
        
        
        
        ">
      <a href="/trick/">
          奇技淫巧
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/trick/efficient-kubectl/" title="kubectl 高效技巧" class="dd-item ">
        <a href="/trick/efficient-kubectl/">
        kubectl 高效技巧
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/trick/yaml/" title="yaml 片段" class="dd-item 
        
        
        
        ">
      <a href="/trick/yaml/">
          yaml 片段
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/trick/yaml/deployment/" title="Deployment" class="dd-item ">
        <a href="/trick/yaml/deployment/">
        Deployment
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/trick/yaml/affnity/" title="亲和与反亲和" class="dd-item ">
        <a href="/trick/yaml/affnity/">
        亲和与反亲和
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/trick/perf-in-container/" title="在容器内使用 perf" class="dd-item ">
        <a href="/trick/perf-in-container/">
        在容器内使用 perf
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/trick/shell/" title="实用命令与脚本" class="dd-item 
        
        
        
        ">
      <a href="/trick/shell/">
          实用命令与脚本
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/trick/shell/pod/" title="Pod 相关脚本" class="dd-item ">
        <a href="/trick/shell/pod/">
        Pod 相关脚本
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/trick/shell/network/" title="网络调试相关脚本" class="dd-item ">
        <a href="/trick/shell/network/">
        网络调试相关脚本
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/trick/shell/node/" title="节点相关脚本" class="dd-item ">
        <a href="/trick/shell/node/">
        节点相关脚本
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/trick/wildcard-domain-forward/" title="泛域名动态转发 Service" class="dd-item ">
        <a href="/trick/wildcard-domain-forward/">
        泛域名动态转发 Service
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/monitoring/" title="监控指南" class="dd-item 
        parent
        
        
        ">
      <a href="/monitoring/">
          监控指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/monitoring/kube-prometheus-quickstart/" title="使用 kube-promethues 快速上手集群监控" class="dd-item ">
        <a href="/monitoring/kube-prometheus-quickstart/">
        使用 kube-promethues 快速上手集群监控
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/" title="打造云原生大型分布式监控系统" class="dd-item 
        parent
        
        
        ">
      <a href="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/">
          打造云原生大型分布式监控系统
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/optimize-prometheus-in-large-scale/" title="大规模场景下 Prometheus 的优化手段" class="dd-item ">
        <a href="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/optimize-prometheus-in-large-scale/">
        大规模场景下 Prometheus 的优化手段
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-arch/" title="Thanos 架构详解" class="dd-item ">
        <a href="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-arch/">
        Thanos 架构详解
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy/" title="Thanos 部署与实践" class="dd-item active">
        <a href="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy/">
        Thanos 部署与实践
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/monitoring/promql/" title="PromQL 技巧" class="dd-item ">
        <a href="/monitoring/promql/">
        PromQL 技巧
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
             
            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/log/" title="日志收集" class="dd-item 
        
        
        
        ">
      <a href="/log/">
          日志收集
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/log/loki-stack/" title="利用 Loki/Promtail/Grafana 收集分析日志" class="dd-item ">
        <a href="/log/loki-stack/">
        利用 Loki/Promtail/Grafana 收集分析日志
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/bigdata-ai/" title="大数据与 AI" class="dd-item 
        
        
        
        ">
      <a href="/bigdata-ai/">
          大数据与 AI
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/bigdata-ai/flink-on-kubernetes/" title="Flink on Kubernetes" class="dd-item 
        
        
        
        ">
      <a href="/bigdata-ai/flink-on-kubernetes/">
          Flink on Kubernetes
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/bigdata-ai/flink-on-kubernetes/intro/" title="Flink 介绍" class="dd-item ">
        <a href="/bigdata-ai/flink-on-kubernetes/intro/">
        Flink 介绍
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/bigdata-ai/flink-on-kubernetes/flink-on-kubernetes/" title="Flink on Kubernetes 方案" class="dd-item ">
        <a href="/bigdata-ai/flink-on-kubernetes/flink-on-kubernetes/">
        Flink on Kubernetes 方案
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/bigdata-ai/flink-on-kubernetes/session-cluster/" title="Session Cluster 模式部署" class="dd-item ">
        <a href="/bigdata-ai/flink-on-kubernetes/session-cluster/">
        Session Cluster 模式部署
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/bigdata-ai/flink-on-kubernetes/job-cluster/" title="Job Cluster 模式部署" class="dd-item ">
        <a href="/bigdata-ai/flink-on-kubernetes/job-cluster/">
        Job Cluster 模式部署
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/bigdata-ai/flink-on-kubernetes/native-kubernetes/" title="Native Kubernetes 模式部署" class="dd-item ">
        <a href="/bigdata-ai/flink-on-kubernetes/native-kubernetes/">
        Native Kubernetes 模式部署
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/dev/" title="开发指南" class="dd-item 
        
        
        
        ">
      <a href="/dev/">
          开发指南
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/dev/golang-build/" title="Go 语言编译原理与优化" class="dd-item ">
        <a href="/dev/golang-build/">
        Go 语言编译原理与优化
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dev/client-go/" title="使用 client-go 开发 k8s 应用" class="dd-item ">
        <a href="/dev/client-go/">
        使用 client-go 开发 k8s 应用
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/reference/" title="References" class="dd-item 
        
        
        
        ">
      <a href="/reference/">
          References
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/reference/net-shell/" title="" class="dd-item ">
        <a href="/reference/net-shell/">
        
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="zh" value="https://k8s.imroc.io/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy/" selected>简体中文</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> 清理历史记录</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      
<center>

    
    <a class="github-button" href="https://github.com/imroc/kubernetes-practice-guide" data-icon="octicon-star"
        data-show-count="true" aria-label="Star imroc/kubernetes-practice-guide on GitHub">Star</a>

    
    <a class="github-button" href="https://github.com/imroc/kubernetes-practice-guide/fork"
        data-icon="octicon-repo-forked" data-show-count="true"
        aria-label="Fork imroc/kubernetes-practice-guide on GitHub">Fork</a>

</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='编辑当前页' href="https://github.com/imroc/kubernetes-practice-guide/edit/master/content/zh/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text">编辑当前页</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Kubernetes 实践指南</a> > <a href='/monitoring/'>监控指南</a> > <a href='/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/'>打造云原生大型分布式监控系统</a> > Thanos 部署与实践
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#部署方式">部署方式</a></li>
    <li><a href="#方案选型">方案选型</a>
      <ul>
        <li><a href="#sidecar-or-receiver">Sidecar or Receiver</a></li>
        <li><a href="#评估是否需要-ruler">评估是否需要 Ruler</a></li>
        <li><a href="#评估是否需要-store-gateway-与-compact">评估是否需要 Store Gateway 与 Compact</a></li>
      </ul>
    </li>
    <li><a href="#部署实践">部署实践</a>
      <ul>
        <li><a href="#准备对象存储配置">准备对象存储配置</a></li>
        <li><a href="#给-prometheus-加上-sidecar">给 Prometheus 加上 Sidecar</a></li>
        <li><a href="#安装-query">安装 Query</a></li>
      </ul>
    </li>
    <li><a href="#安装-store-gateway">安装 Store Gateway</a>
      <ul>
        <li><a href="#安装-ruler">安装 Ruler</a></li>
        <li><a href="#安装-compact">安装 Compact</a></li>
        <li><a href="#安装-receiver">安装 Receiver</a></li>
        <li><a href="#指定-query-为数据源">指定 Query 为数据源</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Thanos 部署与实践
            </h1>
          

        


<div class="notices info">
	<p>文档当前状态：Beta </p>
</div>


<h2 id="概述">概述</h2>
<p>上一篇 <a href="../thanos-arch">Thanos 架构详解</a> 我们深入理解了 thanos 的架构设计与实现原理，现在我们来聊聊实战，分享一下如何部署和使用 Thanos。</p>
<h2 id="部署方式">部署方式</h2>
<p>本文聚焦 Thanos 的云原生部署方式，充分利用 Kubernetes 的资源调度与动态扩容能力。从官方 <a href="https://thanos.io/getting-started.md/#community-thanos-kubernetes-applications">这里</a> 可以看到，当前 thanos 在 Kubernetes 上部署有以下三种：</p>
<ul>
<li><a href="https://github.com/coreos/prometheus-operator">prometheus-operator</a>: 集群中安装了 prometheus-operator 后，就可以通过创建 CRD 对象来部署 Thanos 了。</li>
<li><a href="https://hub.helm.sh/charts?q=thanos">社区贡献的一些 helm charts</a>: 很多个版本，目标都是能够使用 helm 来一键部署 thanos。</li>
<li><a href="https://github.com/thanos-io/kube-thanos">kube-thanos</a>: Thanos 官方的开源项目，包含部署 thanos 到 kubernetes 的 jsonnet 模板与 yaml 示例。</li>
</ul>
<p>本文将使用基于 kube-thanos 提供的 yaml 示例 (<code>examples/all/manifests</code>) 来部署，原因是 prometheus-operator 与社区的 helm chart 方式部署多了一层封装，屏蔽了许多细节，并且它们的实现都还不太成熟；直接使用 kubernetes 的 yaml 资源文件部署更直观，也更容易做自定义，而且我相信使用 thanos 的用户通常都是高玩了，也有必要对 thanos 理解透彻，日后才好根据实际场景做架构和配置的调整，直接使用 yaml 部署能够让我们看清细节。</p>
<h2 id="方案选型">方案选型</h2>
<h3 id="sidecar-or-receiver">Sidecar or Receiver</h3>
<p>看了上一篇文章的同学应该知道，目前官方的架构图用的 Sidecar 方案，Receiver 是一个暂时还没有完全发布的组件。通常来说，Sidecar 方案相对成熟一些，最新的数据存储和计算 (比如聚合函数) 比较 &ldquo;分布式&rdquo;，更加高效也更容易扩展。</p>
<p><img src="https://imroc.io/assets/blog/thanos-sidecar.png" alt=""></p>
<p>Receiver 方案是让 Prometheus 通过 remote wirte API 将数据 push 到 Receiver 集中存储 (同样会清理过期数据):</p>
<p><img src="https://imroc.io/assets/blog/thanos-receiver-without-objectstore.png" alt=""></p>
<p>那么该选哪种方案呢？我的建议是：</p>
<ol>
<li>如果你的 Query 跟 Sidecar 离的比较远，比如 Sidecar 分布在多个数据中心，Query 向所有 Sidecar 查数据，速度会很慢，这种情况可以考虑用 Receiver，将数据集中吐到 Receiver，然后 Receiver 与 Query 部署在一起，Query 直接向 Receiver 查最新数据，提升查询性能。</li>
<li>如果你的使用场景只允许 Prometheus 将数据 push 到远程，可以考虑使用 Receiver。比如 IoT 设备没有持久化存储，只能将数据 push 到远程。</li>
</ol>
<p>此外的场景应该都尽量使用 Sidecar 方案。</p>
<h3 id="评估是否需要-ruler">评估是否需要 Ruler</h3>
<p>Ruler 是一个可选组件，原则上推荐尽量使用 Prometheus 自带的 rule 功能 (生成新指标+告警)，这个功能需要一些 Prometheus 最新数据，直接使用 Prometheus 本机 rule 功能和数据，性能开销相比 Thanos Ruler 这种分布式方案小得多，并且几乎不会出错，Thanos Ruler 由于是分布式，所以更容易出错一些。</p>
<p>如果某些有关联的数据分散在多个不同 Prometheus 上，比如对某个大规模服务采集做了分片，每个 Prometheus 仅采集一部分 endpoint 的数据，对于 <code>record</code> 类型的 rule (生成的新指标)，还是可以使用 Prometheus 自带的 rule 功能，在查询时再聚合一下就可以(如果可以接受的话)；对于 <code>alert</code> 类型的 rule，就需要用 Thanos Ruler 来做了，因为有关联的数据分散在多个 Prometheus 上，用单机数据去做 alert 计算是不准确的，就可能会造成误告警或不告警。</p>
<h3 id="评估是否需要-store-gateway-与-compact">评估是否需要 Store Gateway 与 Compact</h3>
<p>Store 也是一个可选组件，也是 Thanos 的一大亮点的关键：数据长期保存。</p>
<p>评估是否需要 Store 组件实际就是评估一下自己是否有数据长期存储的需求，比如查看一两个月前的监控数据。如果有，那么 Thanos 可以将数据上传到对象存储保存。Thanos 支持以下对象存储:</p>
<ul>
<li>Google Cloud Storage</li>
<li>AWS/S3</li>
<li>Azure Storage Account</li>
<li>OpenStack Swift</li>
<li>Tencent COS</li>
<li>AliYun OSS</li>
</ul>
<p>在国内，最方便还是使用腾讯云 COS 或者阿里云 OSS 这样的公有云对象存储服务。如果你的服务没有跑在公有云上，也可以通过跟云服务厂商拉专线的方式来走内网使用对象存储，这样速度通常也是可以满足需求的；如果实在用不了公有云的对象存储服务，也可以自己安装 <a href="https://github.com/minio/minio">minio</a> 来搭建兼容 AWS 的 S3 对象存储服务。</p>
<p>搞定了对象存储，还需要给 Thanos 多个组件配置对象存储相关的信息，以便能够上传与读取监控数据。除 Query 以外的所有 Thanos 组件 (Sidecar、Receiver、Ruler、Store Gateway、Compact) 都需要配置对象存储信息，使用 <code>--objstore.config</code> 直接配置内容或 <code>--objstore.config-file</code> 引用对象存储配置文件，不同对象存储配置方式不一样，参考官方文档: <a href="https://thanos.io/storage.md">https://thanos.io/storage.md</a></p>
<p>通常使用了对象存储来长期保存数据不止要安装 Store Gateway，还需要安装 Compact 来对对象存储里的数据进行压缩与降采样，这样可以提升查询大时间范围监控数据的性能。注意：Compact 并不会减少对象存储的使用空间，而是会增加，增加更长采样间隔的监控数据，这样当查询大时间范围的数据时，就自动拉取更长时间间隔采样的数据以减少查询数据的总量，从而加快查询速度 (大时间范围的数据不需要那么精细)，当放大查看时 (选择其中一小段时间)，又自动选择拉取更短采样间隔的数据，从而也能显示出小时间范围的监控细节。</p>
<h2 id="部署实践">部署实践</h2>
<p>这里以 Thanos 最新版本为例，选择 Sidecar 方案，介绍各个组件的 k8s yaml 定义方式并解释一些重要细节 (根据自身需求，参考上一节的方案选型，自行评估需要安装哪些组件)。</p>
<h3 id="准备对象存储配置">准备对象存储配置</h3>
<p>如果我们要使用对象存储来长期保存数据，那么就要准备下对象存储的配置信息 (<code>thanos-objectstorage-secret.yaml</code>)，比如使用腾讯云 COS 来存储:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Secret
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-objectstorage
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">type</span>: Opaque
<span style="color:#66d9ef">stringData</span>:
  <span style="color:#66d9ef">objectstorage.yaml</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    type: COS</span>
    <span style="color:#66d9ef">config</span>:
      <span style="color:#66d9ef">bucket</span>: <span style="color:#e6db74">&#34;thanos&#34;</span>
      <span style="color:#66d9ef">region</span>: <span style="color:#e6db74">&#34;ap-singapore&#34;</span>
      <span style="color:#66d9ef">app_id</span>: <span style="color:#e6db74">&#34;12*******5&#34;</span>
      <span style="color:#66d9ef">secret_key</span>: <span style="color:#e6db74">&#34;tsY***************************Edm&#34;</span>
      <span style="color:#66d9ef">secret_id</span>: <span style="color:#e6db74">&#34;AKI******************************gEY&#34;</span>
</code></pre></div><p>或者使用阿里云 OSS 存储:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Secret
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-objectstorage
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">type</span>: Opaque
<span style="color:#66d9ef">stringData</span>:
  <span style="color:#66d9ef">objectstorage.yaml</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    type: ALIYUNOSS</span>
    <span style="color:#66d9ef">config</span>:
      <span style="color:#66d9ef">endpoint</span>: <span style="color:#e6db74">&#34;oss-cn-hangzhou-internal.aliyuncs.com&#34;</span>
      <span style="color:#66d9ef">bucket</span>: <span style="color:#e6db74">&#34;thanos&#34;</span>
      <span style="color:#66d9ef">access_key_id</span>: <span style="color:#e6db74">&#34;LTA******************KBu&#34;</span>
      <span style="color:#66d9ef">access_key_secret</span>: <span style="color:#e6db74">&#34;oki************************2HQ&#34;</span>
</code></pre></div><blockquote>
<p>注: 对敏感信息打码了</p>
</blockquote>
<h3 id="给-prometheus-加上-sidecar">给 Prometheus 加上 Sidecar</h3>
<p>如果选用 Sidecar 方案，就需要给 Prometheus 加上 Thanos Sidecar，准备 <code>prometheus.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus-headless
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: prometheus
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">type</span>: ClusterIP
  <span style="color:#66d9ef">clusterIP</span>: None
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: prometheus
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: web
    <span style="color:#66d9ef">protocol</span>: TCP
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">9090</span>
    <span style="color:#66d9ef">targetPort</span>: web
  - <span style="color:#66d9ef">name</span>: grpc
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10901</span>
    <span style="color:#66d9ef">targetPort</span>: grpc
---

<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ServiceAccount
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus
  <span style="color:#66d9ef">namespace</span>: thanos

---

<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1beta1
<span style="color:#66d9ef">kind</span>: ClusterRole
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">rules</span>:
- <span style="color:#66d9ef">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
  <span style="color:#66d9ef">resources</span>:
  - nodes
  - nodes/proxy
  - nodes/metrics
  - services
  - endpoints
  - pods
  <span style="color:#66d9ef">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
- <span style="color:#66d9ef">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
  <span style="color:#66d9ef">resources</span>: [<span style="color:#e6db74">&#34;configmaps&#34;</span>]
  <span style="color:#66d9ef">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>]
- <span style="color:#66d9ef">nonResourceURLs</span>: [<span style="color:#e6db74">&#34;/metrics&#34;</span>]
  <span style="color:#66d9ef">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>]

---
<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1beta1
<span style="color:#66d9ef">kind</span>: ClusterRoleBinding
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus
<span style="color:#66d9ef">subjects</span>:
  - <span style="color:#66d9ef">kind</span>: ServiceAccount
    <span style="color:#66d9ef">name</span>: prometheus
    <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">roleRef</span>:
  <span style="color:#66d9ef">kind</span>: ClusterRole
  <span style="color:#66d9ef">name</span>: prometheus
  <span style="color:#66d9ef">apiGroup</span>: rbac.authorization.k8s.io
---

<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: StatefulSet
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-query
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">serviceName</span>: prometheus-headless
  <span style="color:#66d9ef">podManagementPolicy</span>: Parallel
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app.kubernetes.io/name</span>: prometheus
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: prometheus
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">serviceAccountName</span>: prometheus
      <span style="color:#66d9ef">securityContext</span>:
        <span style="color:#66d9ef">fsGroup</span>: <span style="color:#ae81ff">2000</span>
        <span style="color:#66d9ef">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">runAsUser</span>: <span style="color:#ae81ff">1000</span>
      <span style="color:#66d9ef">affinity</span>:
        <span style="color:#66d9ef">podAntiAffinity</span>:
          <span style="color:#66d9ef">requiredDuringSchedulingIgnoredDuringExecution</span>:
          - <span style="color:#66d9ef">labelSelector</span>:
              <span style="color:#66d9ef">matchExpressions</span>:
              - <span style="color:#66d9ef">key</span>: app.kubernetes.io/name
                <span style="color:#66d9ef">operator</span>: In
                <span style="color:#66d9ef">values</span>:
                - prometheus
            <span style="color:#66d9ef">topologyKey</span>: kubernetes.io/hostname
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">name</span>: prometheus
        <span style="color:#66d9ef">image</span>: quay.io/prometheus/prometheus:v2<span style="color:#ae81ff">.15.2</span>
        <span style="color:#66d9ef">args</span>:
        - --config.file=/etc/prometheus/config_out/prometheus.yaml
        - --storage.tsdb.path=/prometheus
        - --storage.tsdb.retention.time=10d
        - --web.route-prefix=/
        - --web.enable-lifecycle
        - --storage.tsdb.no-lockfile
        - --storage.tsdb.min-block-duration=2h
        - --storage.tsdb.max-block-duration=2h
        - --log.level=debug
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">9090</span>
          <span style="color:#66d9ef">name</span>: web
          <span style="color:#66d9ef">protocol</span>: TCP
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">6</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/healthy
            <span style="color:#66d9ef">port</span>: web
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#66d9ef">successThreshold</span>: <span style="color:#ae81ff">1</span>
          <span style="color:#66d9ef">timeoutSeconds</span>: <span style="color:#ae81ff">3</span>
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">120</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/ready
            <span style="color:#66d9ef">port</span>: web
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#66d9ef">successThreshold</span>: <span style="color:#ae81ff">1</span>
          <span style="color:#66d9ef">timeoutSeconds</span>: <span style="color:#ae81ff">3</span>
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">mountPath</span>: /etc/prometheus/config_out
          <span style="color:#66d9ef">name</span>: prometheus-config-out
          <span style="color:#66d9ef">readOnly</span>: <span style="color:#66d9ef">true</span>
        - <span style="color:#66d9ef">mountPath</span>: /prometheus
          <span style="color:#66d9ef">name</span>: prometheus-storage
        - <span style="color:#66d9ef">mountPath</span>: /etc/prometheus/rules
          <span style="color:#66d9ef">name</span>: prometheus-rules
      - <span style="color:#66d9ef">name</span>: thanos
        <span style="color:#66d9ef">image</span>: quay.io/thanos/thanos:v0<span style="color:#ae81ff">.11.0</span>
        <span style="color:#66d9ef">args</span>:
        - sidecar
        - --log.level=debug
        - --tsdb.path=/prometheus
        - --prometheus.url=http://<span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9090</span>
        - --objstore.config-file=/etc/thanos/objectstorage.yaml
        - --reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl
        - --reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml
        - --reloader.rule-dir=/etc/prometheus/rules/
        <span style="color:#66d9ef">env</span>:
        - <span style="color:#66d9ef">name</span>: POD_NAME
          <span style="color:#66d9ef">valueFrom</span>:
            <span style="color:#66d9ef">fieldRef</span>:
              <span style="color:#66d9ef">fieldPath</span>: metadata.name
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">name</span>: http-sidecar
          <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10902</span>
        - <span style="color:#66d9ef">name</span>: grpc
          <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10901</span>
        <span style="color:#66d9ef">livenessProbe</span>:
            <span style="color:#66d9ef">httpGet</span>:
              <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
              <span style="color:#66d9ef">path</span>: /-/healthy
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">path</span>: /-/ready
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">name</span>: prometheus-config-tmpl
          <span style="color:#66d9ef">mountPath</span>: /etc/prometheus/config
        - <span style="color:#66d9ef">name</span>: prometheus-config-out
          <span style="color:#66d9ef">mountPath</span>: /etc/prometheus/config_out
        - <span style="color:#66d9ef">name</span>: prometheus-rules
          <span style="color:#66d9ef">mountPath</span>: /etc/prometheus/rules
        - <span style="color:#66d9ef">name</span>: prometheus-storage
          <span style="color:#66d9ef">mountPath</span>: /prometheus
        - <span style="color:#66d9ef">name</span>: thanos-objectstorage
          <span style="color:#66d9ef">subPath</span>: objectstorage.yaml
          <span style="color:#66d9ef">mountPath</span>: /etc/thanos/objectstorage.yaml
      <span style="color:#66d9ef">volumes</span>:
      - <span style="color:#66d9ef">name</span>: prometheus-config-tmpl
        <span style="color:#66d9ef">configMap</span>:
          <span style="color:#66d9ef">defaultMode</span>: <span style="color:#ae81ff">420</span>
          <span style="color:#66d9ef">name</span>: prometheus-config-tmpl
      - <span style="color:#66d9ef">name</span>: prometheus-config-out
        <span style="color:#66d9ef">emptyDir</span>: {}
      - <span style="color:#66d9ef">name</span>: prometheus-rules
        <span style="color:#66d9ef">configMap</span>:
          <span style="color:#66d9ef">name</span>: prometheus-rules
      - <span style="color:#66d9ef">name</span>: thanos-objectstorage
        <span style="color:#66d9ef">secret</span>:
          <span style="color:#66d9ef">secretName</span>: thanos-objectstorage
  <span style="color:#66d9ef">volumeClaimTemplates</span>:
  - <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">name</span>: prometheus-storage
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: prometheus
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">accessModes</span>:
      - ReadWriteOnce
      <span style="color:#66d9ef">resources</span>:
        <span style="color:#66d9ef">requests</span>:
          <span style="color:#66d9ef">storage</span>: 200Gi
      <span style="color:#66d9ef">volumeMode</span>: Filesystem
</code></pre></div><ul>
<li>Prometheus 使用 StatefulSet 方式部署，挂载数据盘以便存储最新监控数据。</li>
<li>由于 Prometheus 副本之间没有启动顺序的依赖，所以 podManagementPolicy 指定为 Parallel，加快启动速度。</li>
<li>为 Prometheus 绑定足够的 RBAC 权限，以便后续配置使用 k8s 的服务发现 (<code>kubernetes_sd_configs</code>) 时能够正常工作。</li>
<li>为 Prometheus 创建 headless 类型 service，一方面是 StatefulSet 本身需要指定 headless 的 <code>serviceName</code>，另一方面是为后续 Thanos Query 通过 DNS SRV 记录来动态发现 Sidecar 的 gRPC 端点做准备 (使用 headless service 才能让 DNS SRV 正确返回所有端点)。</li>
<li>使用两个 Prometheus 副本，用于实现高可用。</li>
<li>使用硬反亲和，避免 Prometheus 部署在同一节点，既可以分散压力也可以避免单点故障。</li>
<li>Prometheus 使用 <code>--storage.tsdb.retention.time</code> 指定数据保留时长，默认15天，可以根据数据增长速度和数据盘大小做适当调整(数据增长取决于采集的指标和目标端点的数量和采集频率)。</li>
<li>Sidecar 使用 <code>--objstore.config-file</code> 引用我们刚刚创建并挂载的对象存储配置文件，用于上传数据到对象存储。</li>
<li>通常会给 Prometheus 附带一个 quay.io/coreos/prometheus-config-reloader 来监听配置变更并动态加载，但 thanos sidecar 也为我们提供了这个功能，所以可以直接用 thanos sidecar 来实现此功能，也支持配置文件根据模板动态生成：<code>--reloader.config-file</code> 指定 Prometheus 配置文件模板，<code>--reloader.config-envsubst-file</code> 指定生成配置文件的存放路径，假设是 <code>/etc/prometheus/config_out/prometheus.yaml</code> ，那么 <code>/etc/prometheus/config_out</code> 这个路径使用 emptyDir 让 Prometheus 与 Sidecar 实现配置文件共享挂载，Prometheus 再通过 <code>--config.file</code> 指定生成出来的配置文件，当配置有更新时，挂载的配置文件也会同步更新，Sidecar 也会通知 Prometheus 重新加载配置。另外，Sidecar 与 Prometheus 也挂载同一份 rules 配置文件，配置更新后 Sidecar 仅通知 Prometheus 加载配置，不支持模板，因为 rules 配置不需要模板来动态生成。</li>
</ul>
<p>然后再给 Prometheus 准备配置 (<code>prometheus-config.yaml</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus-config-tmpl
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">prometheus.yaml.tmpl</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">    global:</span>
      <span style="color:#66d9ef">scrape_interval</span>: 5s
      <span style="color:#66d9ef">evaluation_interval</span>: 5s
      <span style="color:#66d9ef">external_labels</span>:
        <span style="color:#66d9ef">cluster</span>: prometheus-ha
        <span style="color:#66d9ef">prometheus_replica</span>: $(POD_NAME)
    <span style="color:#66d9ef">rule_files</span>:
    - /etc/prometheus/rules/<span style="color:#75715e">*rules.yaml</span>
    <span style="color:#66d9ef">scrape_configs</span>:
    - <span style="color:#66d9ef">job_name</span>: cadvisor
      <span style="color:#66d9ef">metrics_path</span>: /metrics/cadvisor
      <span style="color:#66d9ef">scrape_interval</span>: 10s
      <span style="color:#66d9ef">scrape_timeout</span>: 10s
      <span style="color:#66d9ef">scheme</span>: https
      <span style="color:#66d9ef">tls_config</span>:
        <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#66d9ef">bearer_token_file</span>: /var/run/secrets/kubernetes.io/serviceaccount/token
      <span style="color:#66d9ef">kubernetes_sd_configs</span>:
      - <span style="color:#66d9ef">role</span>: node
      <span style="color:#66d9ef">relabel_configs</span>:
      - <span style="color:#66d9ef">action</span>: labelmap
        <span style="color:#66d9ef">regex</span>: __meta_kubernetes_node_label_(.+)
---

<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus-rules
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">name</span>: prometheus-rules
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">alert-rules.yaml</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">    groups:</span>
    - <span style="color:#66d9ef">name</span>: k8s.rules
      <span style="color:#66d9ef">rules</span>:
      - <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">          sum(rate(container_cpu_usage_seconds_total{job=&#34;cadvisor&#34;, image!=&#34;&#34;, container!=&#34;&#34;}[5m])) by (namespace)</span>
        <span style="color:#66d9ef">record</span>: namespace:container_cpu_usage_seconds_total:sum_rate
      - <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">          sum(container_memory_usage_bytes{job=&#34;cadvisor&#34;, image!=&#34;&#34;, container!=&#34;&#34;}) by (namespace)</span>
        <span style="color:#66d9ef">record</span>: namespace:container_memory_usage_bytes:sum
      - <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">          sum by (namespace, pod, container) (</span>
            rate(container_cpu_usage_seconds_total{job=<span style="color:#e6db74">&#34;cadvisor&#34;</span>, image!=<span style="color:#e6db74">&#34;&#34;</span>, container!=<span style="color:#e6db74">&#34;&#34;</span>}[5m])
          )
        <span style="color:#66d9ef">record</span>: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate
</code></pre></div><ul>
<li>本文重点不在 prometheus 的配置文件，所以这里仅以采集 kubelet 所暴露的 cadvisor 容器指标的简单配置为例。</li>
<li>Prometheus 实例采集的所有指标数据里都会额外加上 <code>external_labels</code> 里指定的 label，通常用 <code>cluster</code> 区分当前 Prometheus 所在集群的名称，我们再加了个 <code>prometheus_replica</code>，用于区分相同 Prometheus 副本（这些副本所采集的数据除了 <code>prometheus_replica</code> 的值不一样，其它几乎一致，这个值会被 Thanos Sidecar 替换成 Pod 副本的名称，用于 Thanos 实现 Prometheus 高可用）</li>
</ul>
<h3 id="安装-query">安装 Query</h3>
<p>准备 <code>thanos-query.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-query
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-query
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: grpc
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10901</span>
    <span style="color:#66d9ef">targetPort</span>: grpc
  - <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">9090</span>
    <span style="color:#66d9ef">targetPort</span>: http
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-query
---

<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-query
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-query
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-query
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-query
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">affinity</span>:
        <span style="color:#66d9ef">podAntiAffinity</span>:
          <span style="color:#66d9ef">preferredDuringSchedulingIgnoredDuringExecution</span>:
          - <span style="color:#66d9ef">podAffinityTerm</span>:
              <span style="color:#66d9ef">labelSelector</span>:
                <span style="color:#66d9ef">matchExpressions</span>:
                - <span style="color:#66d9ef">key</span>: app.kubernetes.io/name
                  <span style="color:#66d9ef">operator</span>: In
                  <span style="color:#66d9ef">values</span>:
                  - thanos-query
              <span style="color:#66d9ef">topologyKey</span>: kubernetes.io/hostname
            <span style="color:#66d9ef">weight</span>: <span style="color:#ae81ff">100</span>
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">args</span>:
        - query
        - --log.level=debug
        - --query.auto-downsampling
        - --grpc-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10901</span>
        - --http-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">9090</span>
        - --query.partial-response
        - --query.replica-label=prometheus_replica
        - --query.replica-label=rule_replica
        - --store=dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local
        - --store=dnssrv+_grpc._tcp.thanos-rule.thanos.svc.cluster.local
        - --store=dnssrv+_grpc._tcp.thanos-store.thanos.svc.cluster.local
        <span style="color:#66d9ef">image</span>: thanosio/thanos:v0<span style="color:#ae81ff">.11.0</span>
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/healthy
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">9090</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">30</span>
        <span style="color:#66d9ef">name</span>: thanos-query
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10901</span>
          <span style="color:#66d9ef">name</span>: grpc
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">9090</span>
          <span style="color:#66d9ef">name</span>: http
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">20</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/ready
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">9090</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#66d9ef">terminationMessagePolicy</span>: FallbackToLogsOnError
      <span style="color:#66d9ef">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">120</span>
</code></pre></div><ul>
<li>因为 Query 是无状态的，使用 Deployment 部署，也不需要 headless service，直接创建普通的 service。</li>
<li>使用软反亲和，尽量不让 Query 调度到同一节点。</li>
<li>部署多个副本，实现 Query 的高可用。</li>
<li><code>--query.partial-response</code> 启用 <a href="https://thanos.io/components/query.md/#partial-response">Partial Response</a>，这样可以在部分后端 Store API 返回错误或超时的情况下也能看到正确的监控数据(如果后端 Store API 做了高可用，挂掉一个副本，Query 访问挂掉的副本超时，但由于还有没挂掉的副本，还是能正确返回结果；如果挂掉的某个后端本身就不存在我们需要的数据，挂掉也不影响结果的正确性；总之如果各个组件都做了高可用，想获得错误的结果都难，所以我们有信心启用 Partial Response 这个功能)。</li>
<li><code>--query.auto-downsampling</code> 查询时自动降采样，提升查询效率。</li>
<li><code>--query.replica-label</code> 指定我们刚刚给 Prometheus 配置的 <code>prometheus_replica</code> 这个 external label，Query 向 Sidecar 拉取 Prometheus 数据时会识别这个 label 并自动去重，这样即使挂掉一个副本，只要至少有一个副本正常也不会影响查询结果，也就是可以实现 Prometheus 的高可用。同理，再指定一个 <code>rule_replica</code> 用于给 Ruler 做高可用。</li>
<li><code>--store</code> 指定实现了 Store API 的地址(Sidecar, Ruler, Store Gateway, Receiver)，通常不建议写静态地址，而是使用服务发现机制自动发现 Store API 地址，如果是部署在同一个集群，可以用 DNS SRV 记录来做服务发现，比如 <code>dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local</code>，也就是我们刚刚为包含 Sidecar 的 Prometheus 创建的 headless service (使用 headless service 才能正确实现服务发现)，并且指定了名为 grpc 的 tcp 端口，同理，其它组件也可以按照这样加到 <code>--store</code> 参数里；如果是其它有些组件部署在集群外，无法通过集群 dns 解析 DNS SRV 记录，可以使用配置文件来做服务发现，也就是指定 <code>--store.sd-files</code> 参数，将其它 Store API 地址写在配置文件里 (挂载 ConfigMap)，需要增加地址时直接更新 ConfigMap (不需要重启 Query)。</li>
</ul>
<h2 id="安装-store-gateway">安装 Store Gateway</h2>
<p>准备 <code>thanos-store.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-store
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-store
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">clusterIP</span>: None
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: grpc
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10901</span>
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">10901</span>
  - <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">10902</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-store
---

<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: StatefulSet
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-store
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-store
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-store
  <span style="color:#66d9ef">serviceName</span>: thanos-store
  <span style="color:#66d9ef">podManagementPolicy</span>: Parallel
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-store
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">args</span>:
        - store
        - --log.level=debug
        - --data-dir=/var/thanos/store
        - --grpc-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10901</span>
        - --http-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10902</span>
        - --objstore.config-file=/etc/thanos/objectstorage.yaml
        - --experimental.enable-index-header
        <span style="color:#66d9ef">image</span>: thanosio/thanos:v0<span style="color:#ae81ff">.11.0</span>
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">8</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/healthy
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">30</span>
        <span style="color:#66d9ef">name</span>: thanos-store
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10901</span>
          <span style="color:#66d9ef">name</span>: grpc
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10902</span>
          <span style="color:#66d9ef">name</span>: http
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">20</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/ready
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#66d9ef">terminationMessagePolicy</span>: FallbackToLogsOnError
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">mountPath</span>: /var/thanos/store
          <span style="color:#66d9ef">name</span>: data
          <span style="color:#66d9ef">readOnly</span>: <span style="color:#66d9ef">false</span>
        - <span style="color:#66d9ef">name</span>: thanos-objectstorage
          <span style="color:#66d9ef">subPath</span>: objectstorage.yaml
          <span style="color:#66d9ef">mountPath</span>: /etc/thanos/objectstorage.yaml
      <span style="color:#66d9ef">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">120</span>
      <span style="color:#66d9ef">volumes</span>:
      - <span style="color:#66d9ef">name</span>: thanos-objectstorage
        <span style="color:#66d9ef">secret</span>:
          <span style="color:#66d9ef">secretName</span>: thanos-objectstorage
  <span style="color:#66d9ef">volumeClaimTemplates</span>:
  - <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-store
      <span style="color:#66d9ef">name</span>: data
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">accessModes</span>:
      - ReadWriteOnce
      <span style="color:#66d9ef">resources</span>:
        <span style="color:#66d9ef">requests</span>:
          <span style="color:#66d9ef">storage</span>: 10Gi
</code></pre></div><ul>
<li>Store Gateway 实际也可以做到一定程度的无状态，它会需要一点磁盘空间来对对象存储做索引以加速查询，但数据不那么重要，是可以删除的，删除后会自动去拉对象存储查数据重新建立索引。这里我们避免每次重启都重新建立索引，所以用 StatefulSet 部署 Store Gateway，挂载一块小容量的磁盘(索引占用不到多大空间)。</li>
<li>同样创建 headless service，用于 Query 对 Store Gateway 进行服务发现。</li>
<li>部署两个副本，实现 Store Gateway 的高可用。</li>
<li>Store Gateway 也需要对象存储的配置，用于读取对象存储的数据，所以要挂载对象存储的配置文件。</li>
</ul>
<h3 id="安装-ruler">安装 Ruler</h3>
<p>准备 Ruler 部署配置 <code>thanos-ruler.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-rule
  <span style="color:#66d9ef">name</span>: thanos-rule
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">clusterIP</span>: None
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: grpc
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10901</span>
    <span style="color:#66d9ef">targetPort</span>: grpc
  - <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
    <span style="color:#66d9ef">targetPort</span>: http
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-rule
---

<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: StatefulSet
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-rule
  <span style="color:#66d9ef">name</span>: thanos-rule
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-rule
  <span style="color:#66d9ef">serviceName</span>: thanos-rule
  <span style="color:#66d9ef">podManagementPolicy</span>: Parallel
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-rule
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">args</span>:
        - rule
        - --grpc-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10901</span>
        - --http-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10902</span>
        - --rule-file=/etc/thanos/rules/<span style="color:#75715e">*rules.yaml</span>
        - --objstore.config-file=/etc/thanos/objectstorage.yaml
        - --data-dir=/var/thanos/rule
        - --label=rule_replica=<span style="color:#e6db74">&#34;$(NAME)&#34;</span>
        - --alert.label-drop=<span style="color:#e6db74">&#34;rule_replica&#34;</span>
        - --query=dnssrv+_http._tcp.thanos-query.thanos.svc.cluster.local
        <span style="color:#66d9ef">env</span>:
        - <span style="color:#66d9ef">name</span>: NAME
          <span style="color:#66d9ef">valueFrom</span>:
            <span style="color:#66d9ef">fieldRef</span>:
              <span style="color:#66d9ef">fieldPath</span>: metadata.name
        <span style="color:#66d9ef">image</span>: thanosio/thanos:v0<span style="color:#ae81ff">.11.0</span>
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">24</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/healthy
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#66d9ef">name</span>: thanos-rule
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10901</span>
          <span style="color:#66d9ef">name</span>: grpc
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10902</span>
          <span style="color:#66d9ef">name</span>: http
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">18</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/ready
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#66d9ef">terminationMessagePolicy</span>: FallbackToLogsOnError
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">mountPath</span>: /var/thanos/rule
          <span style="color:#66d9ef">name</span>: data
          <span style="color:#66d9ef">readOnly</span>: <span style="color:#66d9ef">false</span>
        - <span style="color:#66d9ef">name</span>: thanos-objectstorage
          <span style="color:#66d9ef">subPath</span>: objectstorage.yaml
          <span style="color:#66d9ef">mountPath</span>: /etc/thanos/objectstorage.yaml
        - <span style="color:#66d9ef">name</span>: thanos-rules
          <span style="color:#66d9ef">mountPath</span>: /etc/thanos/rules
      <span style="color:#66d9ef">volumes</span>:
      - <span style="color:#66d9ef">name</span>: thanos-objectstorage
        <span style="color:#66d9ef">secret</span>:
          <span style="color:#66d9ef">secretName</span>: thanos-objectstorage
      - <span style="color:#66d9ef">name</span>: thanos-rules
        <span style="color:#66d9ef">configMap</span>:
          <span style="color:#66d9ef">name</span>: thanos-rules
  <span style="color:#66d9ef">volumeClaimTemplates</span>:
  - <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-rule
      <span style="color:#66d9ef">name</span>: data
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">accessModes</span>:
      - ReadWriteOnce
      <span style="color:#66d9ef">resources</span>:
        <span style="color:#66d9ef">requests</span>:
          <span style="color:#66d9ef">storage</span>: 100Gi
</code></pre></div><ul>
<li>Ruler 是有状态服务，使用 Statefulset 部署，挂载磁盘以便存储根据 rule 配置计算出的新数据。</li>
<li>同样创建 headless service，用于 Query 对 Ruler 进行服务发现。</li>
<li>部署两个副本，且使用 <code>--label=rule_replica=</code> 给所有数据添加 <code>rule_replica</code> 的 label (与 Query 配置的 <code>replica_label</code> 相呼应)，用于实现 Ruler 高可用。同时指定 <code>--alert.label-drop</code> 为 <code>rule_replica</code>，在触发告警发送通知给 AlertManager 时，去掉这个 label，以便让 AlertManager 自动去重 (避免重复告警)。</li>
<li>使用 <code>--query</code> 指定 Query 地址，这里还是用 DNS SRV 来做服务发现，但效果跟配 <code>dns+thanos-query.thanos.svc.cluster.local:9090</code> 是一样的，最终都是通过 Query 的 ClusterIP (VIP) 访问，因为它是无状态的，可以直接由 K8S 来给我们做负载均衡。</li>
<li>Ruler 也需要对象存储的配置，用于上传计算出的数据到对象存储，所以要挂载对象存储的配置文件。</li>
<li><code>--rule-file</code> 指定挂载的 rule 配置，Ruler 根据配置来生成数据和触发告警。</li>
</ul>
<p>再准备 Ruler 配置文件 <code>thanos-ruler-config.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-rules
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">name</span>: thanos-rules
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">record.rules.yaml</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">    groups:</span>
    - <span style="color:#66d9ef">name</span>: k8s.rules
      <span style="color:#66d9ef">rules</span>:
      - <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">          sum(rate(container_cpu_usage_seconds_total{job=&#34;cadvisor&#34;, image!=&#34;&#34;, container!=&#34;&#34;}[5m])) by (namespace)</span>
        <span style="color:#66d9ef">record</span>: namespace:container_cpu_usage_seconds_total:sum_rate
      - <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">          sum(container_memory_usage_bytes{job=&#34;cadvisor&#34;, image!=&#34;&#34;, container!=&#34;&#34;}) by (namespace)</span>
        <span style="color:#66d9ef">record</span>: namespace:container_memory_usage_bytes:sum
      - <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">          sum by (namespace, pod, container) (</span>
            rate(container_cpu_usage_seconds_total{job=<span style="color:#e6db74">&#34;cadvisor&#34;</span>, image!=<span style="color:#e6db74">&#34;&#34;</span>, container!=<span style="color:#e6db74">&#34;&#34;</span>}[5m])
          )
        <span style="color:#66d9ef">record</span>: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate
</code></pre></div><ul>
<li>配置内容仅为示例，根据自身情况来配置，格式基本兼容 Prometheus 的 rule 配置格式，参考: <a href="https://thanos.io/components/rule.md/#configuring-rules">https://thanos.io/components/rule.md/#configuring-rules</a></li>
</ul>
<h3 id="安装-compact">安装 Compact</h3>
<p>准备 Compact 部署配置 <code>thanos-compact.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-compact
  <span style="color:#66d9ef">name</span>: thanos-compact
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
    <span style="color:#66d9ef">targetPort</span>: http
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-compact
---

<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: StatefulSet
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-compact
  <span style="color:#66d9ef">name</span>: thanos-compact
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-compact
  <span style="color:#66d9ef">serviceName</span>: thanos-compact
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-compact
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">args</span>:
        - compact
        - --wait
        - --objstore.config-file=/etc/thanos/objectstorage.yaml
        - --data-dir=/var/thanos/compact
        - --debug.accept-malformed-index
        - --log.level=debug
        - --retention.resolution-raw=90d
        - --retention.resolution-5m=180d
        - --retention.resolution-1h=360d
        <span style="color:#66d9ef">image</span>: thanosio/thanos:v0<span style="color:#ae81ff">.11.0</span>
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/healthy
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">30</span>
        <span style="color:#66d9ef">name</span>: thanos-compact
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10902</span>
          <span style="color:#66d9ef">name</span>: http
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">20</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/ready
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#66d9ef">terminationMessagePolicy</span>: FallbackToLogsOnError
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">mountPath</span>: /var/thanos/compact
          <span style="color:#66d9ef">name</span>: data
          <span style="color:#66d9ef">readOnly</span>: <span style="color:#66d9ef">false</span>
        - <span style="color:#66d9ef">name</span>: thanos-objectstorage
          <span style="color:#66d9ef">subPath</span>: objectstorage.yaml
          <span style="color:#66d9ef">mountPath</span>: /etc/thanos/objectstorage.yaml
      <span style="color:#66d9ef">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">120</span>
      <span style="color:#66d9ef">volumes</span>:
      - <span style="color:#66d9ef">name</span>: thanos-objectstorage
        <span style="color:#66d9ef">secret</span>:
          <span style="color:#66d9ef">secretName</span>: thanos-objectstorage
  <span style="color:#66d9ef">volumeClaimTemplates</span>:
  - <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-compact
      <span style="color:#66d9ef">name</span>: data
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">accessModes</span>:
      - ReadWriteOnce
      <span style="color:#66d9ef">resources</span>:
        <span style="color:#66d9ef">requests</span>:
          <span style="color:#66d9ef">storage</span>: 100Gi

</code></pre></div><ul>
<li>Compact 只能部署单个副本，因为如果多个副本都去对对象存储的数据做压缩和降采样的话，会造成冲突。</li>
<li>使用 StatefulSet 部署，方便自动创建和挂载磁盘。磁盘用于存放临时数据，因为 Compact 需要一些磁盘空间来存放数据处理过程中产生的中间数据。</li>
<li><code>--wait</code> 让 Compact 一直运行，轮询新数据来做压缩和降采样。</li>
<li>Compact 也需要对象存储的配置，用于读取对象存储数据以及上传压缩和降采样后的数据到对象存储。</li>
<li>创建一个普通 service，主要用于被 Prometheus 使用 kubernetes 的 endpoints 服务发现来采集指标(其它组件的 service 也一样有这个用途)。</li>
<li><code>--retention.resolution-raw</code> 指定原始数据存放时长，<code>--retention.resolution-5m</code> 指定降采样到数据点 5 分钟间隔的数据存放时长，<code>--retention.resolution-1h</code> 指定降采样到数据点 1 小时间隔的数据存放时长，它们的数据精细程度递减，占用的存储空间也是递减，通常建议它们的存放时间递增配置 (一般只有比较新的数据才会放大看，久远的数据通常只会使用大时间范围查询来看个大致，所以建议将精细程度低的数据存放更长时间)</li>
</ul>
<h3 id="安装-receiver">安装 Receiver</h3>
<p>该组件处于试验阶段，慎用。准备 Receiver 部署配置 <code>thanos-receiver.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-receive-hashrings
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">thanos-receive-hashrings.json</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    [</span>
      {
        <span style="color:#66d9ef">&#34;hashring&#34;: </span><span style="color:#e6db74">&#34;soft-tenants&#34;</span>,
        <span style="color:#e6db74">&#34;endpoints&#34;</span>:
        [
          <span style="color:#e6db74">&#34;thanos-receive-0.thanos-receive.kube-system.svc.cluster.local:10901&#34;</span>,
          <span style="color:#e6db74">&#34;thanos-receive-1.thanos-receive.kube-system.svc.cluster.local:10901&#34;</span>,
          <span style="color:#e6db74">&#34;thanos-receive-2.thanos-receive.kube-system.svc.cluster.local:10901&#34;</span>
        ]
      }
    ]
---

<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: thanos-receive
  <span style="color:#66d9ef">namespace</span>: thanos
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">kubernetes.io/name</span>: thanos-receive
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
    <span style="color:#66d9ef">protocol</span>: TCP
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">10902</span>
  - <span style="color:#66d9ef">name</span>: remote-write
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">19291</span>
    <span style="color:#66d9ef">protocol</span>: TCP
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">19291</span>
  - <span style="color:#66d9ef">name</span>: grpc
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10901</span>
    <span style="color:#66d9ef">protocol</span>: TCP
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">10901</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">kubernetes.io/name</span>: thanos-receive
  <span style="color:#66d9ef">clusterIP</span>: None
---

<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: StatefulSet
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">kubernetes.io/name</span>: thanos-receive
  <span style="color:#66d9ef">name</span>: thanos-receive
  <span style="color:#66d9ef">namespace</span>: thanos
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">kubernetes.io/name</span>: thanos-receive
  <span style="color:#66d9ef">serviceName</span>: thanos-receive
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">kubernetes.io/name</span>: thanos-receive
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">args</span>:
        - receive
        - --grpc-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10901</span>
        - --http-address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">10902</span>
        - --remote-write.address=<span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">19291</span>
        - --objstore.config-file=/etc/thanos/objectstorage.yaml
        - --tsdb.path=/var/thanos/receive
        - --tsdb.retention=12h
        - --label=receive_replica=<span style="color:#e6db74">&#34;$(NAME)&#34;</span>
        - --label=receive=<span style="color:#e6db74">&#34;true&#34;</span>
        - --receive.hashrings-file=/etc/thanos/thanos-receive-hashrings.json
        - --receive.local-endpoint=$(NAME).thanos-receive.thanos.svc.cluster.local:<span style="color:#ae81ff">10901</span>
        <span style="color:#66d9ef">env</span>:
        - <span style="color:#66d9ef">name</span>: NAME
          <span style="color:#66d9ef">valueFrom</span>:
            <span style="color:#66d9ef">fieldRef</span>:
              <span style="color:#66d9ef">fieldPath</span>: metadata.name
        <span style="color:#66d9ef">image</span>: thanosio/thanos:v0<span style="color:#ae81ff">.11.0</span>
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/healthy
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">30</span>
        <span style="color:#66d9ef">name</span>: thanos-receive
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10901</span>
          <span style="color:#66d9ef">name</span>: grpc
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">10902</span>
          <span style="color:#66d9ef">name</span>: http
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">19291</span>
          <span style="color:#66d9ef">name</span>: remote-write
        <span style="color:#66d9ef">readinessProbe</span>:
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /-/ready
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">10902</span>
            <span style="color:#66d9ef">scheme</span>: HTTP
          <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
          <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">30</span>
        <span style="color:#66d9ef">resources</span>:
          <span style="color:#66d9ef">limits</span>:
            <span style="color:#66d9ef">cpu</span>: <span style="color:#e6db74">&#34;4&#34;</span>
            <span style="color:#66d9ef">memory</span>: 8Gi
          <span style="color:#66d9ef">requests</span>:
            <span style="color:#66d9ef">cpu</span>: <span style="color:#e6db74">&#34;2&#34;</span>
            <span style="color:#66d9ef">memory</span>: 4Gi
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">mountPath</span>: /var/thanos/receive
          <span style="color:#66d9ef">name</span>: data
          <span style="color:#66d9ef">readOnly</span>: <span style="color:#66d9ef">false</span>
        - <span style="color:#66d9ef">mountPath</span>: /etc/thanos/thanos-receive-hashrings.json
          <span style="color:#66d9ef">name</span>: thanos-receive-hashrings
          <span style="color:#66d9ef">subPath</span>: thanos-receive-hashrings.json
        - <span style="color:#66d9ef">mountPath</span>: /etc/thanos/objectstorage.yaml
          <span style="color:#66d9ef">name</span>: thanos-objectstorage
          <span style="color:#66d9ef">subPath</span>: objectstorage.yaml
      <span style="color:#66d9ef">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">120</span>
      <span style="color:#66d9ef">volumes</span>:
      - <span style="color:#66d9ef">configMap</span>:
          <span style="color:#66d9ef">defaultMode</span>: <span style="color:#ae81ff">420</span>
          <span style="color:#66d9ef">name</span>: thanos-receive-hashrings
        <span style="color:#66d9ef">name</span>: thanos-receive-hashrings
      - <span style="color:#66d9ef">name</span>: thanos-objectstorage
        <span style="color:#66d9ef">secret</span>:
          <span style="color:#66d9ef">secretName</span>: thanos-objectstorage
  <span style="color:#66d9ef">volumeClaimTemplates</span>:
  - <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app.kubernetes.io/name</span>: thanos-receive
      <span style="color:#66d9ef">name</span>: data
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">accessModes</span>:
      - ReadWriteOnce
      <span style="color:#66d9ef">resources</span>:
        <span style="color:#66d9ef">requests</span>:
          <span style="color:#66d9ef">storage</span>: 200Gi
</code></pre></div><ul>
<li>部署 3 个副本， 配置 hashring， <code>--label=receive_replica</code> 为数据添加 <code>receive_replica</code> 这个 label (Query 的 <code>--query.replica-label</code> 也要加上这个) 来实现 Receiver 的高可用。</li>
<li>Query 要指定 Receiver 后端地址: <code>--store=dnssrv+_grpc._tcp.thanos-receive.thanos.svc.cluster.local</code></li>
<li>request, limit 根据自身规模情况自行做适当调整。</li>
<li><code>--tsdb.retention</code> 根据自身需求调整最新数据的保留时间。</li>
<li>如果改命名空间，记得把 Receiver 的 <code>--receive.local-endpoint</code> 参数也改下，不然会疯狂报错直至 OOMKilled。</li>
</ul>
<p>因为使用了 Receiver 来统一接收 Prometheus 的数据，所以 Prometheus 也不需要 Sidecar 了，但需要给 Prometheus 配置文件里加下 <code>remote_write</code>，让 Prometheus 将数据 push 给 Receiver:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">    <span style="color:#66d9ef">remote_write</span>:
    - <span style="color:#66d9ef">url</span>: http://thanos-receive.thanos.svc.cluster.local:<span style="color:#ae81ff">19291</span>/api/v1/receive
</code></pre></div><h3 id="指定-query-为数据源">指定 Query 为数据源</h3>
<p>查询监控数据时需要指定 Prometheus 数据源地址，由于我们使用了 Thanos 来做分布式，而 Thanos 关键查询入口就是 Query，所以我们需要将数据源地址指定为 Query 的地址，假如使用 Grafana 查询，进入 <code>Configuration</code>-<code>Data Sources</code>-<code>Add data source</code>，选择 Prometheus，指定 thanos query 的地址: <code>http://thanos-query.thanos.svc.cluster.local:9090</code></p>
<h2 id="总结">总结</h2>
<p>本文教了大家如何选型 Thanos 部署方案并详细讲解了各个组件的安装方法，如果仔细阅读完本系列文章，我相信你已经有能力搭建并运维一套大型监控系统了。</p>


<footer class="footline">
	
	
	
	<i class='fas fa-user'></i> <a href="https://imroc.io">roc</a>
    
	 <i class='fas fa-calendar'></i> 2020-04-09
</footer>

        
        </div> 
       
         <div class="entry-shang text-center">
    <p>「真诚赞赏，手留余香」</p>
    <button class="zs show-zs btn btn-bred">赞赏</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
    <div class="zs-modal-head">
        <button type="button" class="close">×</button>
        <span class="author"><img
                src="https://res.cloudinary.com/imroc/image/upload/c_scale,w_128/v1583303821/img/favicon.jpg" />roc</span>
        <p class="tip"><i></i><span>请我喝杯咖啡？</span></p>
    </div>
    <div class="zs-modal-body">
        <div class="zs-modal-btns">
            <button class="btn btn-blink" data-num="2">2元</button>
            <button class="btn btn-blink" data-num="5">5元</button>
            <button class="btn btn-blink" data-num="10">10元</button>
            <button class="btn btn-blink" data-num="50">50元</button>
            <button class="btn btn-blink" data-num="100">100元</button>
            <button class="btn btn-blink" data-num="1">任意金额</button>
        </div>
        <div class="zs-modal-pay">
            <button class="btn btn-bred" id="pay-text">2元</button>
            <p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
            <img src="/img/wechat-2.png" id="pay-image"/>
        </div>
    </div>
    <div class="zs-modal-footer">
        <label>
            <input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked">
            <span class="zs-wechat"><img src="/img/wechat-btn.png" /></span>
        </label>
        <label>
            <input type="radio" name="zs-type" value="alipay" class="zs-type">
            <span class="zs-alipay"><img src="/img/alipay-btn.png" /></span>
        </label>
    </div>
</div>
       
        
          <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  
  console.log("gitalk id:00d5882af12bb692b6e56d0e71d23677")
  var gitalk = new Gitalk({
      clientID: '6e0166abfd4b13fb3f6e',
      clientSecret: '9960a67408e0cc826566869e0e3247017004d007',
      repo: 'kubernetes-practice-guide',
      owner: 'imroc',
      admin: ["imroc"],
      labels: ['Gitalk'],
      title: 'Thanos 部署与实践',
      createIssueManually: false,
      id: '00d5882af12bb692b6e56d0e71d23677',
      distractionFreeMode: true
  });
  gitalk.render('gitalk-container');
</script>
        
      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-arch/" title="Thanos 架构详解"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/monitoring/promql/" title="PromQL 技巧" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>

    

  </body>
</html>